<!DOCTYPE html>
<html>
    <head>
        <!--<link rel="stylesheet" href="UploadedMedia.css" type="text/css" />-->
    </head>
    <body>
        <div class="videoInput">
            <form>
                <div id="frame-timerange">
                    <input id="startTime" type="text" value=""/>
                    <input id="endTime" type="text" value=""/>
                </div> 
                
                <div>
                    <button id="SubmitTimes" type="button">Get Frames</button>
                </div>
            </form>
        </div>
        
        <div id="media-uploaded">
            <div id="video-media">
                <video id="video" width="320" height="240" controls></video>
            </div>
        </div>
        
        <div id="frames-area">
            <div id="video-frames">Video frames appear here</div>
        </div>
    
        <script>
            /**
             * Variables for getting local media file
             * */
             
        
            /**
             * Variables for InputContent event handling
            **/
            const Submit = document.getElementById("SubmitTimes");
            const StartTime = document.getElementById("startTime");
            const EndTime = document.getElementById("endTime");
            const SetTimes = [StartTime, EndTime];
            const times = [0,0];
            
            /**
             * Variables for Video handling
            **/
            const video = document.getElementById("video");
            video.preload = "auto";
            video.src = "res/test.mp4";
            video.type = "video/mp4";
            
            const framesArea = document.getElementById("video-frames");
            const fps = 1/4;//gives me 4 fps
            
            
            video.addEventListener('loadeddata', function() {
            /**
             * event makes sure video is fully loaded
             * sets the playback time to 0
             **/
             this.currentTime = 0;
            }, false);
            
            Submit.addEventListener("click", function GetFrames(){
                /**
                 * event used to trigger getting of video frames
                 **/
                 
                if(framesArea.childElementCount > 0){
                    /**
                     * reloading the video so there are no playback issues
                     * might remove later
                     * */
                    video.load();
                }
                
                /**
                 * Might turn this into a function later
                 * */
                let j=0;
                for(let i of SetTimes){
                    /**
                     * Converts the times into a format
                     * that video events can use 
                     * Take substrings using the colon as base
                     * parse substrings to ints
                     * multiply string1 by 60 and add on string2 for a time
                    **/
                    let x = parseInt(i.value.substr(0, i.value.length - 3), 10);
                    let y = parseInt(i.value.substr(i.value.length - 2), 10);
                    i = (x*60) + y;
                    times[j] = i;
                    j++;
                }
                
                video.currentTime = times[0];//setting a new currentTime triggers seeking
            });
            
           video.addEventListener('seeked', function() {
                    /**when frame is captured, increase with fps trying to get a decent framerate
                     * keep in mind this for rotoscoping so the framerate may not have to be that high
                     * */
                    times[0]+=(fps);
                    
                   //if still in seeking range
                    if ( times[0] <= times[1] ) {
                        /**Event is triggered when seeking is done
                        * generateThumbnail() will get the currentTime and convert it to canvas element
                        * */
                        generateThumbnail(this);
                        //another seeked event triggered
                        video.currentTime = times[0];
                    }
                	else {
                        //getting a nodelist of the newly made canvas elements
                        let canvas = document.getElementsByClassName("frame-canvas");
                		for(var i=0;i<canvas.length;i++){
                		    canvas[i].addEventListener("click", function(e){
                                /** Takes frames makes them downloadable; onclick Not needed now
                                 * canvas is inside an anchor tag
                                 * user clicks canvas, but click event is on the anchor tag
                                 * bubbling cause click to trigger anyways
                                 * use event.target to get canvas
                                 * use this to manipulate anchor tag
                                 **/
                                 
                                /* Takes frames makes them downloadable; onclick Not needed now
                                 * canvas is inside an anchor tag
                                 * user clicks canvas, but click event is on the anchor tag
                                 * bubbling cause click to trigger anyways
                                 * use event.target to get canvas
                                 * use this to manipulate anchor tag
                                 //use this for bubbling to <a> parent
                                let filename = "frame.png";
                                let frame = e.target;
                                this.href = frame.toDataURL();
                                this.download = filename;
                                framesArea.removeChild(this);
                                **/
                                let filename = "frame.png";
                                let frame = e.target;
                                this.href = frame.toDataURL();
                                this.download = filename;
                                framesArea.removeChild(this);
                            }, false);
                		}
                    }
            
                }, false);
            
            function generateThumbnail ( frame ) {
                if(framesArea.innerHTML == "Video frames appear here"){
                    //Get rid of this if/else later
                    framesArea.innerHTML = '';
                }
                    //let a = document.createElement("a");
                    let c = document.createElement("canvas");
                    c.className = "frame-canvas";
                    //a.className = "frame-canvas";
                    //a.appendChild(c);
                    
                    let ctx = c.getContext("2d");
                    c.width = 160;
                    c.height = 90;
                    ctx.drawImage(frame, 0, 0, 160, 90);
                    framesArea.appendChild(c);

            }
            
        </script>
    </body>
</html>